import{b as te,r,j as e,d as m,e as v,f as b,g as U,h as B,B as y,i as h,T as W,M as ae,P as le,k as T,L as ne,l as re,S as ie,m as ce,t as P}from"./index-Di9k1Ec8.js";import{b as de,u as oe,D as V,H as me,F as xe,P as ue,C as he}from"./Footer-Bx9jF1vN.js";import{A as ge,s as fe}from"./AddressSelector-CRd1N3ed.js";const x=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}),pe=()=>{const{state:g,subtotal:O,availableSubtotal:i,increment:H,decrement:Q,removeItem:F,clear:D,validateCart:A,getAvailableItems:G,getUnavailableItems:Y}=de(),{currentDepotId:c}=oe(),w=g.items.reduce((s,t)=>s+t.quantity,0),J=te(),n=G(),l=Y(),[a,K]=r.useState(null),[C,M]=r.useState(!1),[d,X]=r.useState(null),[j,$]=r.useState(0),[Z,L]=r.useState(!1),[I,z]=r.useState(null),[f,N]=r.useState(!1),p=r.useRef(null),R=r.useRef(!1);R.current=g.items.length>0,r.useEffect(()=>{const s=V.getCurrentLocation();X(s)},[]),r.useEffect(()=>{g.items.length>0&&c&&p.current===null&&(console.log("[CheckoutPage] Initial validation on mount"),N(!0),p.current=c,A(c).finally(()=>{console.log("[CheckoutPage] Initial validation completed"),N(!1)}))},[]),r.useEffect(()=>{const s=R.current,t=c!==p.current;console.log("[CheckoutPage] Effect triggered:",{hasItems:s,currentDepotId:c,lastValidatedDepot:p.current,depotChanged:t,isValidating:f}),s&&c&&t&&!f?(console.log("[CheckoutPage] Starting validation for depot:",c),N(!0),p.current=c,A(c).finally(()=>{console.log("[CheckoutPage] Validation completed"),N(!1)})):console.log("[CheckoutPage] Skipping validation:",{hasItems:s,hasDepotId:!!c,depotChanged:t,isValidating:f})},[c,f]),r.useEffect(()=>{(async()=>{L(!0),z(null);try{const t=await ce("/wallet");let u=null;t&&t.data&&typeof t.data.balance=="number"?u=t.data.balance:typeof(t==null?void 0:t.balance)=="number"&&(u=t.balance),$(typeof u=="number"?u:0)}catch(t){console.error("Failed to fetch wallet balance:",t),z((t==null?void 0:t.message)||"Failed to fetch wallet"),$(0)}finally{L(!1)}})()},[]);const E=a!==null,_=async()=>{if(!(n.length===0||!E||C)&&!(l.length>0&&!window.confirm(`${l.length} item${l.length>1?"s":""} in your cart ${l.length>1?"are":"is"} not available in this location and will be removed from your order. Continue with ${n.length} available item${n.length>1?"s":""}?`)))try{M(!0);const s=V.getCurrentDepotId(),t=s?parseInt(s.toString()):null;console.log("[Checkout] Using depot ID:",t);const u=n.map(o=>({name:o.name,variantName:o.variantName,imageUrl:o.imageUrl||null,price:o.price,quantity:o.quantity,productId:o.productId,depotProductVariantId:o.variantId})),k=0,S=i,ee=Math.max(0,Math.min(j||0,S+k));if(!a){P.error("Please select a delivery address");return}const se={customer:{name:a.recipientName,email:null,mobile:a.mobile,addressLine1:a.plotBuilding,addressLine2:a.streetArea,city:a.city,state:a.state,pincode:a.pincode},items:u,subtotal:S,deliveryFee:k,totalAmount:S+k,walletamt:ee,paymentMode:null,paymentRefNo:null,paymentStatus:"PENDING",paymentDate:null,depotId:t||null,deliveryAddressId:a.id},q=await fe.createOrder(se);P.success(`Order created: ${q.data.orderNo}`),D(),J(`/admin/snf-orders/${q.data.id}`)}catch(s){const t=(s==null?void 0:s.message)||"Failed to create order";P.error(t)}finally{M(!1)}};return e.jsxs("div",{className:"min-h-screen flex flex-col bg-background",children:[e.jsx(me,{cartCount:w,onSearch:()=>{}}),e.jsx("main",{className:"flex-1",children:e.jsxs("section",{className:"container mx-auto px-4 md:px-6 lg:px-8 py-6",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold mb-4",children:"Checkout"}),g.items.length===0?e.jsxs(m,{children:[e.jsxs(v,{children:[e.jsx(b,{children:"Your cart is empty"}),e.jsx(U,{children:"Add some products to continue"})]}),e.jsx(B,{children:e.jsx(y,{asChild:!0,children:e.jsx("a",{href:"/snf",children:"Continue shopping"})})})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[f&&e.jsx(m,{children:e.jsx(h,{className:"py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"}),"Checking item availability..."]})})}),n.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-lg font-medium",children:"Available Items"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",n.length," item",n.length>1?"s":"",")"]})]}),n.map(s=>e.jsx(m,{children:e.jsx(h,{className:"py-4",children:e.jsxs("div",{className:"flex gap-4 items-start",children:[e.jsx("div",{className:"size-20 shrink-0 rounded-md overflow-hidden bg-muted/30 grid place-items-center",children:s.imageUrl?e.jsx("img",{src:s.imageUrl,alt:s.name,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"No image"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm md:text-base font-medium truncate",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.variantName})]}),e.jsx("button",{className:"p-2 rounded hover:bg-accent",onClick:()=>F(s.variantId),"aria-label":`Remove ${s.name}`,children:e.jsx(W,{className:"size-4"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 border rounded-md px-2 py-1",children:[e.jsx("button",{className:"p-1 rounded hover:bg-accent",onClick:()=>Q(s.variantId),"aria-label":"Decrease quantity",children:e.jsx(ae,{className:"size-4"})}),e.jsx("span",{className:"text-sm w-6 text-center",children:s.quantity}),e.jsx("button",{className:"p-1 rounded hover:bg-accent",onClick:()=>H(s.variantId),"aria-label":"Increase quantity",children:e.jsx(le,{className:"size-4"})})]}),e.jsx("div",{className:"text-sm md:text-base font-semibold",children:x.format(s.price*s.quantity)})]})]})]})})},s.variantId))]}),l.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mt-6",children:[e.jsx(T,{className:"size-5 text-amber-500"}),e.jsx("h2",{className:"text-lg font-medium text-amber-700",children:"Not Available in This Location"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",l.length," item",l.length>1?"s":"",")"]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800",children:"These items will be removed from your order during checkout."}),l.map(s=>e.jsx(m,{className:"opacity-60 border-amber-200",children:e.jsx(h,{className:"py-4",children:e.jsxs("div",{className:"flex gap-4 items-start",children:[e.jsx("div",{className:"size-20 shrink-0 rounded-md overflow-hidden bg-muted/50 grid place-items-center",children:s.imageUrl?e.jsx("img",{src:s.imageUrl,alt:s.name,className:"h-full w-full object-cover grayscale",loading:"lazy"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"No image"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm md:text-base font-medium truncate line-through",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.variantName}),e.jsx("p",{className:"text-xs text-amber-600 mt-1",children:s.unavailableReason})]}),e.jsx("button",{className:"p-2 rounded hover:bg-accent",onClick:()=>F(s.variantId),"aria-label":`Remove ${s.name}`,children:e.jsx(W,{className:"size-4"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Qty: ",s.quantity]}),e.jsx("div",{className:"text-sm md:text-base text-muted-foreground line-through",children:x.format(s.price*s.quantity)})]})]})]})})},s.variantId))]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{variant:"outline",onClick:D,children:"Clear cart"}),e.jsx(y,{asChild:!0,variant:"outline",children:e.jsx(ne,{to:"/snf",children:"Continue shopping"})})]})]}),e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(m,{className:d&&d.depotName?"border-green-200":"border-yellow-200",children:[e.jsx(v,{className:"pb-2",children:e.jsxs(b,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"size-4"}),"Delivery Location"]})}),e.jsx(h,{children:d&&d.depotName?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Pincode:"}),e.jsx("span",{children:d.pincode})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Depot:"}),e.jsx("span",{children:d.depotName})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Area:"}),e.jsx("span",{children:d.areaName})]}),e.jsxs("div",{className:"text-xs text-green-600 mt-2 flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-green-600 rounded-full"}),"Service available"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm text-yellow-700 flex items-start gap-2",children:[e.jsx(T,{className:"size-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Please set your delivery location in the header to see depot information."})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Orders will be assigned to the default depot if no location is selected."})]})})]}),e.jsx(ge,{selectedAddressId:a==null?void 0:a.id,onAddressSelect:K}),a&&e.jsxs(m,{className:"border-green-200 bg-green-50/30",children:[e.jsx(v,{className:"pb-2",children:e.jsx(b,{className:"text-sm font-medium text-green-800",children:"Selected Delivery Address"})}),e.jsx(h,{className:"text-sm",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:a.recipientName}),e.jsxs("p",{className:"text-muted-foreground",children:[a.plotBuilding,a.plotBuilding&&a.streetArea?", ":"",a.streetArea]}),a.landmark&&e.jsxs("p",{className:"text-muted-foreground text-xs",children:["Landmark: ",a.landmark]}),e.jsxs("p",{className:"text-muted-foreground",children:[a.city,", ",a.state," - ",a.pincode]}),e.jsxs("p",{className:"text-muted-foreground text-xs",children:["Mobile: ",a.mobile]})]})})]}),e.jsxs(m,{children:[e.jsxs(v,{className:"pb-2",children:[e.jsx(b,{children:"Order Summary"}),e.jsx(U,{children:n.length>0&&l.length>0?e.jsxs(e.Fragment,{children:[n.length," available • ",l.length," unavailable"]}):e.jsxs(e.Fragment,{children:[w," item",w!==1?"s":""]})})]}),e.jsxs(h,{className:"space-y-2",children:[l.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total cart value"}),e.jsx("span",{className:"text-muted-foreground line-through",children:x.format(O)})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Available items"}),e.jsx("span",{className:"font-medium",children:x.format(i)})]})]}),l.length===0&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsx("span",{className:"font-medium",children:x.format(i)})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Delivery"}),e.jsx("span",{className:"font-medium",children:"₹0"})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Wallet deduction"}),e.jsxs("span",{className:"font-medium text-green-600",children:["-",Z?"...":x.format(Math.max(0,Math.min(j||0,i)))]})]}),e.jsx(ie,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Amount payable"}),e.jsx("span",{className:"font-semibold",children:(()=>{const s=Math.max(0,Math.min(j||0,i));return x.format(Math.max(0,i-s))})()})]}),l.length>0&&e.jsxs("div",{className:"text-xs text-amber-600 bg-amber-50 p-2 rounded mt-2",children:[l.length," item",l.length>1?"s":""," will be removed from your order"]}),I&&e.jsx("p",{className:"text-xs text-destructive",children:I}),!I&&e.jsx("p",{className:"text-xs text-muted-foreground",children:(()=>{const s=Math.max(0,Math.min(j||0,i)),t=Math.max(0,i-s);return s>0&&t>0?`₹${s.toFixed(0)} will be deducted from your wallet. Remaining ₹${t.toFixed(0)} to be collected via Cash/UPI before delivery.`:s>=i&&i>0?`Full amount of ₹${i.toFixed(0)} will be deducted from your wallet.`:"No wallet balance applied."})()})]}),e.jsxs(B,{className:"flex-col gap-2",children:[e.jsx(y,{className:"w-full",onClick:_,disabled:n.length===0||!E||C,children:C?"Placing order...":l.length>0?`Proceed with ${n.length} item${n.length>1?"s":""}`:"Proceed to payment"}),n.length===0&&g.items.length>0&&e.jsx("p",{className:"text-xs text-red-600 text-center",children:"No items are available for delivery in this location"}),!a&&n.length>0&&e.jsx("p",{className:"text-xs text-red-600 text-center",children:"Please select a delivery address to continue"}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"By placing your order, you agree to our terms and policies."})]})]})]})]})]})}),e.jsx(xe,{})]})},be=()=>e.jsx(ue,{children:e.jsx(he,{children:e.jsx(pe,{})})});export{be as default};
