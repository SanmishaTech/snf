import{j as e,d as u,e as p,f as N,g as K,h,i as X,S as re,k as ie,l as ce,m as de,n as oe,b as me,r as i,o as Z,p as _,B as F,T as ee,M as xe,P as ue,q as se,L as he,s as ge,t as fe,v as je,w as L}from"./index-DA0rZHy4.js";import{b as pe,u as Ne,D as U,H as ve,F as ye,P as be,C as we}from"./Footer-PGRWDOnl.js";import{A as De,s as Ce}from"./AddressSelector-Dfq7UpCc.js";const Se=({deliverySchedule:d,selectedDate:A,onDateSelect:c,className:C=""})=>{const $={sunday:0,monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6},S=(()=>{if(!d||d.length===0)return[];const o=[],I=new Date;for(let g=1;g<=14;g++){const l=new Date(I);l.setDate(I.getDate()+g);const v=l.getDay();for(const y of d){const n=$[y.toLowerCase()];if(v===n&&!o.some(t=>t.dayName===y)){const t=l.toISOString().split("T")[0],E=l.toLocaleDateString("en-IN",{weekday:"short",month:"short",day:"numeric",year:"numeric"});o.push({date:t,dayName:y,formattedDate:E})}}}return o.sort((g,l)=>new Date(g.date).getTime()-new Date(l.date).getTime())})();return!d||d.length===0?e.jsxs(u,{className:`border-amber-200 ${C}`,children:[e.jsx(p,{className:"pb-3",children:e.jsxs(N,{className:"flex items-center gap-2 text-sm font-medium text-amber-700",children:[e.jsx(K,{className:"h-4 w-4"}),"Delivery Schedule"]})}),e.jsx(h,{children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-amber-600",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx("span",{children:"Schedule not specified for this area"})]})})]}):e.jsxs(u,{className:`border-blue-200 bg-blue-50/30 ${C}`,children:[e.jsx(p,{className:"pb-3",children:e.jsxs(N,{className:"flex items-center gap-2 text-sm font-medium text-blue-800",children:[e.jsx(K,{className:"h-4 w-4"}),"Select Delivery Date"]})}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-700",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx("span",{children:"Choose your preferred delivery date:"})]}),e.jsxs(re,{value:A,onValueChange:c,children:[e.jsx(ie,{className:"w-full",children:e.jsx(ce,{placeholder:"Select a delivery date"})}),e.jsx(de,{children:S.map(o=>e.jsx(oe,{value:o.date,children:o.formattedDate},o.date))})]}),e.jsx("div",{className:"text-xs text-blue-600 bg-blue-100/50 p-2 rounded-md",children:"ðŸ’¡ Select your preferred delivery date from the available options above. Next available date for each delivery day is shown."})]})})]})},j=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}),Ie=()=>{const{state:d,subtotal:A,availableSubtotal:c,increment:C,decrement:$,removeItem:M,clear:S,validateCart:o,getAvailableItems:I,getUnavailableItems:g}=pe(),{currentDepotId:l}=Ne(),v=d.items.reduce((s,a)=>s+a.quantity,0),y=me(),n=I(),r=g(),[t,E]=i.useState(null),[b,V]=i.useState(""),[R,W]=i.useState(!1),[m,B]=i.useState(null),[k,O]=i.useState(0),[te,H]=i.useState(!1),[z,Q]=i.useState(null),[w,P]=i.useState(!1),D=i.useRef(null),G=i.useRef(!1);G.current=d.items.length>0,i.useEffect(()=>{const s=U.getCurrentLocation();B(s)},[l]),i.useEffect(()=>{const s=a=>{if(a.key==="snf.deliveryLocation"||a.key===null){const x=U.getCurrentLocation();console.log("[CheckoutPage] Delivery location changed via storage:",x),B(x)}};return window.addEventListener("storage",s),()=>window.removeEventListener("storage",s)},[]),i.useEffect(()=>{d.items.length>0&&l&&D.current===null&&(console.log("[CheckoutPage] Initial validation on mount"),P(!0),D.current=l,o(l).finally(()=>{console.log("[CheckoutPage] Initial validation completed"),P(!1)}))},[]),i.useEffect(()=>{const s=G.current,a=l!==D.current;console.log("[CheckoutPage] Effect triggered:",{hasItems:s,currentDepotId:l,lastValidatedDepot:D.current,depotChanged:a,isValidating:w}),s&&l&&a&&!w?(console.log("[CheckoutPage] Starting validation for depot:",l),P(!0),D.current=l,o(l).finally(()=>{console.log("[CheckoutPage] Validation completed"),P(!1)})):console.log("[CheckoutPage] Skipping validation:",{hasItems:s,hasDepotId:!!l,depotChanged:a,isValidating:w}),a&&l&&(console.log("[CheckoutPage] Resetting delivery date due to depot change"),V(""))},[l,w]),i.useEffect(()=>{(async()=>{H(!0),Q(null);try{const a=await je("/wallet");let x=null;a&&a.data&&typeof a.data.balance=="number"?x=a.data.balance:typeof(a==null?void 0:a.balance)=="number"&&(x=a.balance),O(typeof x=="number"?x:0)}catch(a){console.error("Failed to fetch wallet balance:",a),Q((a==null?void 0:a.message)||"Failed to fetch wallet"),O(0)}finally{H(!1)}})()},[]);const Y=t!==null&&b!=="",ae=async()=>{if(!(n.length===0||!Y||R)&&!(r.length>0&&!window.confirm(`${r.length} item${r.length>1?"s":""} in your cart ${r.length>1?"are":"is"} not available in this location and will be removed from your order. Continue with ${n.length} available item${n.length>1?"s":""}?`)))try{W(!0);const s=U.getCurrentDepotId(),a=s?parseInt(s.toString()):null;console.log("[Checkout] Using depot ID:",a);const x=n.map(f=>({name:f.name,variantName:f.variantName,imageUrl:f.imageUrl||null,price:f.price,quantity:f.quantity,productId:f.productId,depotProductVariantId:f.variantId})),T=0,q=c,le=Math.max(0,Math.min(k||0,q+T));if(!t){L.error("Please select a delivery address");return}if(!b){L.error("Please select a delivery date");return}const ne={customer:{name:t.recipientName,email:null,mobile:t.mobile,addressLine1:t.plotBuilding,addressLine2:t.streetArea,city:t.city,state:t.state,pincode:t.pincode},items:x,subtotal:q,deliveryFee:T,totalAmount:q+T,walletamt:le,paymentMode:null,paymentRefNo:null,paymentStatus:"PENDING",paymentDate:null,depotId:a||null,deliveryAddressId:t.id,deliveryDate:b},J=await Ce.createOrder(ne);L.success(`Order created: ${J.data.orderNo}`),S(),y(`/admin/snf-orders/${J.data.id}`)}catch(s){const a=(s==null?void 0:s.message)||"Failed to create order";L.error(a)}finally{W(!1)}};return e.jsxs("div",{className:"min-h-screen flex flex-col bg-background",children:[e.jsx(ve,{cartCount:v,onSearch:()=>{}}),e.jsx("main",{className:"flex-1",children:e.jsxs("section",{className:"container mx-auto px-4 md:px-6 lg:px-8 py-6",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold mb-4",children:"Checkout"}),d.items.length===0?e.jsxs(u,{children:[e.jsxs(p,{children:[e.jsx(N,{children:"Your cart is empty"}),e.jsx(Z,{children:"Add some products to continue"})]}),e.jsx(_,{children:e.jsx(F,{asChild:!0,children:e.jsx("a",{href:"/snf",children:"Continue shopping"})})})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[w&&e.jsx(u,{children:e.jsx(h,{className:"py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary"}),"Checking item availability..."]})})}),n.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-lg font-medium",children:"Available Items"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",n.length," item",n.length>1?"s":"",")"]})]}),n.map(s=>e.jsx(u,{children:e.jsx(h,{className:"py-4",children:e.jsxs("div",{className:"flex gap-4 items-start",children:[e.jsx("div",{className:"size-20 shrink-0 rounded-md overflow-hidden bg-muted/30 grid place-items-center",children:s.imageUrl?e.jsx("img",{src:s.imageUrl,alt:s.name,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"No image"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm md:text-base font-medium truncate",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.variantName})]}),e.jsx("button",{className:"p-2 rounded hover:bg-accent",onClick:()=>M(s.variantId),"aria-label":`Remove ${s.name}`,children:e.jsx(ee,{className:"size-4"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 border rounded-md px-2 py-1",children:[e.jsx("button",{className:"p-1 rounded hover:bg-accent",onClick:()=>$(s.variantId),"aria-label":"Decrease quantity",children:e.jsx(xe,{className:"size-4"})}),e.jsx("span",{className:"text-sm w-6 text-center",children:s.quantity}),e.jsx("button",{className:"p-1 rounded hover:bg-accent",onClick:()=>C(s.variantId),"aria-label":"Increase quantity",children:e.jsx(ue,{className:"size-4"})})]}),e.jsx("div",{className:"text-sm md:text-base font-semibold",children:j.format(s.price*s.quantity)})]})]})]})})},s.variantId))]}),r.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 mt-6",children:[e.jsx(se,{className:"size-5 text-amber-500"}),e.jsx("h2",{className:"text-lg font-medium text-amber-700",children:"Not Available in This Location"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",r.length," item",r.length>1?"s":"",")"]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800",children:"These items will be removed from your order during checkout."}),r.map(s=>e.jsx(u,{className:"opacity-60 border-amber-200",children:e.jsx(h,{className:"py-4",children:e.jsxs("div",{className:"flex gap-4 items-start",children:[e.jsx("div",{className:"size-20 shrink-0 rounded-md overflow-hidden bg-muted/50 grid place-items-center",children:s.imageUrl?e.jsx("img",{src:s.imageUrl,alt:s.name,className:"h-full w-full object-cover grayscale",loading:"lazy"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"No image"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm md:text-base font-medium truncate line-through",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.variantName}),e.jsx("p",{className:"text-xs text-amber-600 mt-1",children:s.unavailableReason})]}),e.jsx("button",{className:"p-2 rounded hover:bg-accent",onClick:()=>M(s.variantId),"aria-label":`Remove ${s.name}`,children:e.jsx(ee,{className:"size-4"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Qty: ",s.quantity]}),e.jsx("div",{className:"text-sm md:text-base text-muted-foreground line-through",children:j.format(s.price*s.quantity)})]})]})]})})},s.variantId))]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{variant:"outline",onClick:S,children:"Clear cart"}),e.jsx(F,{asChild:!0,variant:"outline",children:e.jsx(he,{to:"/snf",children:"Continue shopping"})})]})]}),e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(u,{className:m&&m.depotName?"border-green-200":"border-yellow-200",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"size-4"}),"Delivery Location"]})}),e.jsx(h,{children:m&&m.depotName?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Pincode:"}),e.jsx("span",{children:m.pincode})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Depot:"}),e.jsx("span",{children:m.depotName})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Area:"}),e.jsx("span",{children:m.areaName})]}),e.jsxs("div",{className:"text-xs text-green-600 mt-2 flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-green-600 rounded-full"}),"Service available"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm text-yellow-700 flex items-start gap-2",children:[e.jsx(se,{className:"size-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Please set your delivery location in the header to see depot information."})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Orders will be assigned to the default depot if no location is selected."})]})})]}),m&&m.deliverySchedule&&e.jsx(Se,{deliverySchedule:m.deliverySchedule,selectedDate:b,onDateSelect:V}),e.jsx(De,{selectedAddressId:t==null?void 0:t.id,onAddressSelect:E}),t&&e.jsxs(u,{className:"border-green-200 bg-green-50/30",children:[e.jsx(p,{className:"pb-2",children:e.jsx(N,{className:"text-sm font-medium text-green-800",children:"Selected Delivery Address"})}),e.jsx(h,{className:"text-sm",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:t.recipientName}),e.jsxs("p",{className:"text-muted-foreground",children:[t.plotBuilding,t.plotBuilding&&t.streetArea?", ":"",t.streetArea]}),t.landmark&&e.jsxs("p",{className:"text-muted-foreground text-xs",children:["Landmark: ",t.landmark]}),e.jsxs("p",{className:"text-muted-foreground",children:[t.city,", ",t.state," - ",t.pincode]}),e.jsxs("p",{className:"text-muted-foreground text-xs",children:["Mobile: ",t.mobile]})]})})]}),e.jsxs(u,{children:[e.jsxs(p,{className:"pb-2",children:[e.jsx(N,{children:"Order Summary"}),e.jsx(Z,{children:n.length>0&&r.length>0?e.jsxs(e.Fragment,{children:[n.length," available â€¢ ",r.length," unavailable"]}):e.jsxs(e.Fragment,{children:[v," item",v!==1?"s":""]})})]}),e.jsxs(h,{className:"space-y-2",children:[r.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total cart value"}),e.jsx("span",{className:"text-muted-foreground line-through",children:j.format(A)})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Available items"}),e.jsx("span",{className:"font-medium",children:j.format(c)})]})]}),r.length===0&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsx("span",{className:"font-medium",children:j.format(c)})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Delivery"}),e.jsx("span",{className:"font-medium",children:"â‚¹0"})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Wallet deduction"}),e.jsxs("span",{className:"font-medium text-green-600",children:["-",te?"...":j.format(Math.max(0,Math.min(k||0,c)))]})]}),e.jsx(fe,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Amount payable"}),e.jsx("span",{className:"font-semibold",children:(()=>{const s=Math.max(0,Math.min(k||0,c));return j.format(Math.max(0,c-s))})()})]}),r.length>0&&e.jsxs("div",{className:"text-xs text-amber-600 bg-amber-50 p-2 rounded mt-2",children:[r.length," item",r.length>1?"s":""," will be removed from your order"]}),z&&e.jsx("p",{className:"text-xs text-destructive",children:z}),!z&&e.jsx("p",{className:"text-xs text-muted-foreground",children:(()=>{const s=Math.max(0,Math.min(k||0,c)),a=Math.max(0,c-s);return s>0&&a>0?`â‚¹${s.toFixed(0)} will be deducted from your wallet. Remaining â‚¹${a.toFixed(0)} to be collected via Cash/UPI before delivery.`:s>=c&&c>0?`Full amount of â‚¹${c.toFixed(0)} will be deducted from your wallet.`:"No wallet balance applied."})()})]}),e.jsxs(_,{className:"flex-col gap-2",children:[e.jsx(F,{className:"w-full",onClick:ae,disabled:n.length===0||!Y||R,children:R?"Placing order...":r.length>0?`Proceed with ${n.length} item${n.length>1?"s":""}`:"Proceed to payment"}),n.length===0&&d.items.length>0&&e.jsx("p",{className:"text-xs text-red-600 text-center",children:"No items are available for delivery in this location"}),!t&&n.length>0&&e.jsx("p",{className:"text-xs text-red-600 text-center",children:"Please select a delivery address to continue"}),t&&!b&&n.length>0&&e.jsx("p",{className:"text-xs text-red-600 text-center",children:"Please select a delivery date to continue"}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"By placing your order, you agree to our terms and policies."})]})]})]})]})]})}),e.jsx(ye,{})]})},Le=()=>e.jsx(be,{children:e.jsx(we,{children:e.jsx(Ie,{})})});export{Le as default};
