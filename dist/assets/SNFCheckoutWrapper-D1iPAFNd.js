import{d as K,e as Y,f as _,g as J,t as S,h as X,i as H,r as d,R as Z,j as e,k as o,l as j,m as p,M as w,n as f,S as z,B as m,L as C,P,o as R,q as ee,s as se,v as ae,w as W,H as te,b as le,x as O,y as $,T as re,z as ne,A as ie,D as ce}from"./index-BtRkqcd7.js";import{a as de,D as U,H as oe,F as me,P as xe,C as ue}from"./Footer-D0AQsJ6e.js";const he={createOrder:n=>K("/snf-orders",n)},je=()=>{const n=Y(),{data:r=[],isLoading:y,isError:x,error:c,refetch:v}=_({queryKey:["addresses"],queryFn:async()=>await H("/delivery-addresses")}),u=J({mutationFn:async s=>await X(`/delivery-addresses/${s}/set-default`,{}),onSuccess:()=>{n.invalidateQueries({queryKey:["addresses"]}),S.success("Default address updated")},onError:s=>S.error((s==null?void 0:s.message)||"Failed to set default")}),N=r.find(s=>s.isDefault);return{addresses:r,defaultAddress:N,isLoading:y,isError:x,error:c,refetch:v,setDefaultAddress:u.mutate,isSettingDefault:u.isPending}},pe=({selectedAddressId:n,onAddressSelect:r,onEditAddress:y})=>{const{addresses:x,defaultAddress:c,isLoading:v,isError:u,error:N}=je(),[s,D]=d.useState(n||(c==null?void 0:c.id)||"");Z.useEffect(()=>{!n&&c&&!s&&(D(c.id),r(c))},[c,n,s,r]);const b=t=>{const i=x.find(k=>k.id===t);i&&(D(t),r(i))};return v?e.jsxs(o,{children:[e.jsx(j,{children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(w,{className:"size-4"}),"Delivery Address"]})}),e.jsx(f,{className:"space-y-3",children:[...Array(2)].map((t,i)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{className:"h-4 w-2/3"}),e.jsx(z,{className:"h-3 w-1/2"}),e.jsx(z,{className:"h-3 w-5/6"})]},i))})]}):u?e.jsxs(o,{className:"border-red-200",children:[e.jsx(j,{children:e.jsxs(p,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(w,{className:"size-4"}),"Address Error"]})}),e.jsxs(f,{children:[e.jsx("p",{className:"text-sm text-red-600 mb-3",children:(N==null?void 0:N.message)||"Failed to load addresses"}),e.jsx(m,{asChild:!0,variant:"outline",size:"sm",children:e.jsx(C,{to:"/snf/address",children:"Manage Addresses"})})]})]}):!x||x.length===0?e.jsxs(o,{className:"border-yellow-200",children:[e.jsx(j,{children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(w,{className:"size-4"}),"No Addresses Found"]})}),e.jsxs(f,{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"You need to add a delivery address to place an order."}),e.jsx(m,{asChild:!0,size:"sm",children:e.jsxs(C,{to:"/snf/addresses",children:[e.jsx(P,{className:"size-4 mr-2"}),"Add Address"]})})]})]}):e.jsxs(o,{children:[e.jsx(j,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(w,{className:"size-4"}),"Select Delivery Address"]}),e.jsx(m,{asChild:!0,variant:"outline",size:"sm",children:e.jsxs(C,{to:"/snf/address",children:[e.jsx(R,{className:"size-4 mr-2"}),"Manage"]})})]})}),e.jsxs(f,{children:[e.jsx(ee,{value:s,onValueChange:b,className:"space-y-3",children:x.map(t=>e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(se,{value:t.id,id:t.id,className:"mt-1"}),e.jsx(ae,{htmlFor:t.id,className:"flex-1 cursor-pointer",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:t.recipientName}),t.label&&e.jsx(W,{variant:"secondary",className:"text-xs",children:t.label}),t.isDefault&&e.jsxs(W,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200 text-xs",children:[e.jsx(te,{className:"h-3 w-3 mr-1"}),"Default"]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[t.plotBuilding,t.plotBuilding&&t.streetArea?", ":"",t.streetArea]}),t.landmark&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Landmark: ",t.landmark]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[t.city,", ",t.state," - ",t.pincode]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Mobile: ",t.mobile]})]})}),y&&e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>y(t),className:"mt-1",children:e.jsx(R,{className:"size-4"})})]},t.id))}),e.jsx("div",{className:"mt-4 pt-3 border-t",children:e.jsx(m,{asChild:!0,variant:"outline",size:"sm",className:"w-full",children:e.jsxs(C,{to:"/snf/address",children:[e.jsx(P,{className:"size-4 mr-2"}),"Add New Address"]})})})]})]})},F=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}),fe=()=>{const{state:n,subtotal:r,increment:y,decrement:x,removeItem:c,clear:v}=de(),u=n.items.reduce((a,l)=>a+l.quantity,0),N=le(),[s,D]=d.useState(null),[b,t]=d.useState(!1),[i,k]=d.useState(null),[A,M]=d.useState(0),[Q,L]=d.useState(!1),[I,q]=d.useState(null);d.useEffect(()=>{const a=U.getCurrentLocation();k(a)},[]),d.useEffect(()=>{(async()=>{L(!0),q(null);try{const l=await H("/wallet");let h=null;l&&l.data&&typeof l.data.balance=="number"?h=l.data.balance:typeof(l==null?void 0:l.balance)=="number"&&(h=l.balance),M(typeof h=="number"?h:0)}catch(l){console.error("Failed to fetch wallet balance:",l),q((l==null?void 0:l.message)||"Failed to fetch wallet"),M(0)}finally{L(!1)}})()},[]);const B=s!==null,T=async()=>{if(!(n.items.length===0||!B||b))try{t(!0);const a=U.getCurrentDepotId();console.log("[Checkout] Using depot ID:",a);const l=n.items.map(g=>({name:g.name,variantName:g.variantName,imageUrl:g.imageUrl||null,price:g.price,quantity:g.quantity,productId:g.productId,depotProductVariantId:g.variantId})),h=0,G=Math.max(0,Math.min(A||0,r+h));if(!s){S.error("Please select a delivery address");return}const V={customer:{name:s.recipientName,email:null,mobile:s.mobile,addressLine1:s.plotBuilding,addressLine2:s.streetArea,city:s.city,state:s.state,pincode:s.pincode},items:l,subtotal:r,deliveryFee:h,totalAmount:r+h,walletamt:G,paymentMode:null,paymentRefNo:null,paymentStatus:"PENDING",paymentDate:null,depotId:a||null,deliveryAddressId:s.id},E=await he.createOrder(V);S.success(`Order created: ${E.data.orderNo}`),v(),N(`/admin/snf-orders/${E.data.id}`)}catch(a){const l=(a==null?void 0:a.message)||"Failed to create order";S.error(l)}finally{t(!1)}};return e.jsxs("div",{className:"min-h-screen flex flex-col bg-background",children:[e.jsx(oe,{cartCount:u,onSearch:()=>{}}),e.jsx("main",{className:"flex-1",children:e.jsxs("section",{className:"container mx-auto px-4 md:px-6 lg:px-8 py-6",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-semibold mb-4",children:"Checkout"}),n.items.length===0?e.jsxs(o,{children:[e.jsxs(j,{children:[e.jsx(p,{children:"Your cart is empty"}),e.jsx(O,{children:"Add some products to continue"})]}),e.jsx($,{children:e.jsx(m,{asChild:!0,children:e.jsx("a",{href:"/snf",children:"Continue shopping"})})})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[n.items.map(a=>e.jsx(o,{children:e.jsx(f,{className:"py-4",children:e.jsxs("div",{className:"flex gap-4 items-start",children:[e.jsx("div",{className:"size-20 shrink-0 rounded-md overflow-hidden bg-muted/30 grid place-items-center",children:a.imageUrl?e.jsx("img",{src:a.imageUrl,alt:a.name,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"No image"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm md:text-base font-medium truncate",children:a.name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:a.variantName})]}),e.jsx("button",{className:"p-2 rounded hover:bg-accent",onClick:()=>c(a.variantId),"aria-label":`Remove ${a.name}`,children:e.jsx(re,{className:"size-4"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 border rounded-md px-2 py-1",children:[e.jsx("button",{className:"p-1 rounded hover:bg-accent",onClick:()=>x(a.variantId),"aria-label":"Decrease quantity",children:e.jsx(ne,{className:"size-4"})}),e.jsx("span",{className:"text-sm w-6 text-center",children:a.quantity}),e.jsx("button",{className:"p-1 rounded hover:bg-accent",onClick:()=>y(a.variantId),"aria-label":"Increase quantity",children:e.jsx(P,{className:"size-4"})})]}),e.jsx("div",{className:"text-sm md:text-base font-semibold",children:F.format(a.price*a.quantity)})]})]})]})})},a.variantId)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{variant:"outline",onClick:v,children:"Clear cart"}),e.jsx(m,{asChild:!0,variant:"outline",children:e.jsx(C,{to:"/snf",children:"Continue shopping"})})]})]}),e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(o,{className:i&&i.depotName?"border-green-200":"border-yellow-200",children:[e.jsx(j,{className:"pb-2",children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(w,{className:"size-4"}),"Delivery Location"]})}),e.jsx(f,{children:i&&i.depotName?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Pincode:"}),e.jsx("span",{children:i.pincode})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Depot:"}),e.jsx("span",{children:i.depotName})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Area:"}),e.jsx("span",{children:i.areaName})]}),e.jsxs("div",{className:"text-xs text-green-600 mt-2 flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-green-600 rounded-full"}),"Service available"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm text-yellow-700 flex items-start gap-2",children:[e.jsx(ie,{className:"size-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Please set your delivery location in the header to see depot information."})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Orders will be assigned to the default depot if no location is selected."})]})})]}),e.jsx(pe,{selectedAddressId:s==null?void 0:s.id,onAddressSelect:D}),s&&e.jsxs(o,{className:"border-green-200 bg-green-50/30",children:[e.jsx(j,{className:"pb-2",children:e.jsx(p,{className:"text-sm font-medium text-green-800",children:"Selected Delivery Address"})}),e.jsx(f,{className:"text-sm",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:s.recipientName}),e.jsxs("p",{className:"text-muted-foreground",children:[s.plotBuilding,s.plotBuilding&&s.streetArea?", ":"",s.streetArea]}),s.landmark&&e.jsxs("p",{className:"text-muted-foreground text-xs",children:["Landmark: ",s.landmark]}),e.jsxs("p",{className:"text-muted-foreground",children:[s.city,", ",s.state," - ",s.pincode]}),e.jsxs("p",{className:"text-muted-foreground text-xs",children:["Mobile: ",s.mobile]})]})})]}),e.jsxs(o,{children:[e.jsxs(j,{className:"pb-2",children:[e.jsx(p,{children:"Order Summary"}),e.jsxs(O,{children:[u," item",u!==1?"s":""]})]}),e.jsxs(f,{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsx("span",{className:"font-medium",children:F.format(r)})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Delivery"}),e.jsx("span",{className:"font-medium",children:"₹0"})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Wallet deduction"}),e.jsxs("span",{className:"font-medium text-green-600",children:["-",Q?"...":F.format(Math.max(0,Math.min(A||0,r)))]})]}),e.jsx(ce,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Amount payable"}),e.jsx("span",{className:"font-semibold",children:(()=>{const a=Math.max(0,Math.min(A||0,r));return F.format(Math.max(0,r-a))})()})]}),I&&e.jsx("p",{className:"text-xs text-destructive",children:I}),!I&&e.jsx("p",{className:"text-xs text-muted-foreground",children:(()=>{const a=Math.max(0,Math.min(A||0,r)),l=Math.max(0,r-a);return a>0&&l>0?`₹${a.toFixed(0)} will be deducted from your wallet. Remaining ₹${l.toFixed(0)} to be collected via Cash/UPI before delivery.`:a>=r&&r>0?`Full amount of ₹${r.toFixed(0)} will be deducted from your wallet.`:"No wallet balance applied."})()})]}),e.jsxs($,{className:"flex-col gap-2",children:[e.jsx(m,{className:"w-full",onClick:T,disabled:n.items.length===0||!B||b,children:b?"Placing order...":"Proceed to payment"}),!s&&n.items.length>0&&e.jsx("p",{className:"text-xs text-red-600 text-center",children:"Please select a delivery address to continue"}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"By placing your order, you agree to our terms and policies."})]})]})]})]})]})}),e.jsx(me,{})]})},ye=()=>e.jsx(xe,{children:e.jsx(ue,{children:e.jsx(fe,{})})});export{ye as default};
